{% extends "layout_customer.html" %}

{% block title %}Trang chủ - Storia{% endblock %}

{% block extra_css %}
<style>
    .slider-wrapper {
        max-width: 1200px;
    }
    .movie-card {
        transition: transform 0.3s ease;
    }
    .movie-card:hover {
        transform: translateY(-5px);
    }
    .news-section {
        background: #f8f9fa;
        padding: 3rem 0;
        margin-top: 3rem;
    }
    
    /* Pagination Styles */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 2rem;
        gap: 0.5rem;
    }
    
    .pagination-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border: 1px solid #dee2e6;
        background: white;
        color: darkred;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .pagination-btn:hover {
        background: darkred;
        color: white;
        border-color: darkred;
    }
    
    .pagination-btn.active {
        background: darkred;
        color: white;
        border-color: darkred;
    }
    
    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .pagination-dots {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .pagination-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 1rem;
    }
    
    .page-input {
        width: 50px;
        height: 40px;
        text-align: center;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .page-input:focus {
        border-color: darkred;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(139, 0, 0, 0.25);
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .movie-grid {
        min-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<!--Banner Carousel - banner slider -->
<div class="slider-wrapper mx-auto my-4">
  <div id="mainCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="/static/img/banner1.jpg" class="d-block w-100" alt="Banner 1">
      </div>
      <div class="carousel-item">
        <img src="/static/img/banner2.jpg" class="d-block w-100" alt="Banner 2">
      </div>
      <div class="carousel-item">
        <img src="/static/img/banner3.jpg" class="d-block w-100" alt="Banner 3">
      </div>
      <div class="carousel-item">
        <img src="/static/img/banner4.jpg" class="d-block w-100" alt="Banner 4">
      </div>
    </div>

    <!-- Chấm điều hướng dưới slider -->
    <div class="carousel-indicators" style="bottom: 2px;">
      <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="0" class="active"></button>
      <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="1"></button>
      <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="2"></button>
      <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="3"></button>
    </div>

    <!-- Nút điều hướng trái phải -->
    <button class="carousel-control-prev" type="button" data-bs-target="#mainCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon bg-danger rounded-circle" aria-hidden="true"></span>
      <span class="visually-hidden">Trước</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#mainCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon bg-danger rounded-circle" aria-hidden="true"></span>
      <span class="visually-hidden">Sau</span>
    </button>
  </div>
</div>

<!-- Tabs - Bootstrap -->
<ul class="nav nav-tabs mb-4 justify-content-center" id="movieTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active fw-bold" id="showing-tab" data-bs-toggle="tab" data-bs-target="#showing" type="button" role="tab">Showing</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link fw-bold" id="coming-tab" data-bs-toggle="tab" data-bs-target="#coming" type="button" role="tab">Coming Soon</button>
  </li>
</ul>

<!-- Nội dung từng tab -->
<div class="container">
  <div class="tab-content" id="movieTabsContent">
    <!-- Danh sách phim ĐANG CHIẾU -->
    <div class="tab-pane fade show active" id="showing" role="tabpanel">
      <!-- Loading Spinner -->
      <div class="loading-spinner" id="showingLoading">
        <div class="spinner-border text-danger" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải danh sách phim...</p>
      </div>
      
      <!-- Movie Grid -->
      <div class="movie-grid" id="showingMoviesGrid">
        <!-- Movies will be loaded here dynamically -->
      </div>
      
      <!-- Pagination -->
      <div class="pagination-container" id="showingPagination" style="display: none;">
        <!-- Pagination will be generated here -->
      </div>
    </div>

    <!-- Danh sách phim SẮP CHIẾU -->
    <div class="tab-pane fade" id="coming" role="tabpanel">
      <!-- Loading Spinner -->
      <div class="loading-spinner" id="comingLoading">
        <div class="spinner-border text-danger" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải danh sách phim...</p>
      </div>
      
      <!-- Movie Grid -->
      <div class="movie-grid" id="comingMoviesGrid">
        <!-- Movies will be loaded here dynamically -->
      </div>
      
      <!-- Pagination -->
      <div class="pagination-container" id="comingPagination" style="display: none;">
        <!-- Pagination will be generated here -->
      </div>
    </div>
  </div>
</div>

<!-- Tin tức -->
<div class="news-section">
  <div class="container">
    <h2 class="mb-4 text-center" style="font-weight: 760; color: darkred;">Cinema Corner</h2>
    <div class="row g-4">
      <!-- Card Tin Tức 1 -->
      <div class="col-sm-6 col-md-4 col-lg-4">
        <div class="card shadow">
          <img src="/static/img/news1.jpg" class="card-img-top" alt="News 1">
          <div class="card-body">
            <h5 class="card-title fw-bold">[Review] Elio: Hành Trình Khám Phá Bản Thân Tràn Ngập Sắc Màu</h5>
            <a href="#" class="btn btn-outline-danger rounded-pill w-100">See More</a>
          </div>
        </div>
      </div>

      <!-- Card Tin Tức 2 -->
      <div class="col-sm-6 col-md-4 col-lg-4">
        <div class="card shadow">
          <img src="/static/img/news2.jpg" class="card-img-top" alt="News 2">
          <div class="card-body">
            <h5 class="card-title fw-bold">[Review] How To Train Your Dragon: Live Action Hoàn Hảo Của Bí Kíp Luyện Rồng</h5>
            <a href="#" class="btn btn-outline-danger rounded-pill w-100">See More</a>
          </div>
        </div>
      </div>

      <!-- Card Tin Tức 3 -->
      <div class="col-sm-6 col-md-4 col-lg-4">
        <div class="card shadow">
          <img src="/static/img/news3.jpg" class="card-img-top" alt="News 3">
          <div class="card-body">
            <h5 class="card-title fw-bold">[Review] 28 Years Later: Thế giới Hậu Tận Thế Tàn Khốc</h5>
            <a href="#" class="btn btn-outline-danger rounded-pill w-100">See more</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // JavaScript tùy chỉnh cho trang chủ
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Index new page loaded with layout inheritance!');
    
    // Khởi tạo phân trang cho phim đang chiếu
    initShowingMoviesPagination();
    
    // Khởi tạo phân trang cho phim sắp chiếu
    initComingSoonMoviesPagination();
    
    // Thêm hiệu ứng hover cho movie cards
    document.addEventListener('mouseover', function(e) {
      if (e.target.closest('.movie-card')) {
        e.target.closest('.movie-card').style.transform = 'translateY(-10px)';
      }
    });
    
    document.addEventListener('mouseout', function(e) {
      if (e.target.closest('.movie-card')) {
        e.target.closest('.movie-card').style.transform = 'translateY(0)';
      }
    });
  });

  // Biến global cho phân trang
  let currentPage = 1;
  let totalPages = 1;
  let currentPaginationData = null;
  
  // Biến cho Coming Soon
  let comingCurrentPage = 1;
  let comingTotalPages = 1;
  let comingPaginationData = null;

  // Khởi tạo phân trang cho phim đang chiếu
  function initShowingMoviesPagination() {
    loadShowingMovies(1);
  }

  // Khởi tạo phân trang cho phim sắp chiếu
  function initComingSoonMoviesPagination() {
    loadComingSoonMovies(1);
  }

  // Load danh sách phim đang chiếu
  async function loadShowingMovies(page = 1) {
    const loadingEl = document.getElementById('showingLoading');
    const gridEl = document.getElementById('showingMoviesGrid');
    const paginationEl = document.getElementById('showingPagination');
    
    try {
      // Hiển thị loading
      loadingEl.style.display = 'block';
      gridEl.innerHTML = '';
      paginationEl.style.display = 'none';
      
      // Gọi API
      const response = await fetch(`/api/movies/showing?page=${page}&per_page=6`);
      const data = await response.json();
      
      if (data.success) {
        currentPaginationData = data.pagination;
        currentPage = data.pagination.current_page;
        totalPages = data.pagination.total_pages;
        
        // Render movies
        renderShowingMovies(data.movies);
        
        // Render pagination nếu có nhiều hơn 1 trang
        if (totalPages > 1) {
          renderPagination(data.pagination, 'showing');
        }
      } else {
        console.error('Error loading movies:', data.error);
        gridEl.innerHTML = '<div class="text-center text-muted">Không thể tải danh sách phim</div>';
      }
    } catch (error) {
      console.error('Error:', error);
      gridEl.innerHTML = '<div class="text-center text-muted">Lỗi kết nối</div>';
    } finally {
      loadingEl.style.display = 'none';
    }
  }

  // Load danh sách phim sắp chiếu
  async function loadComingSoonMovies(page = 1) {
    const loadingEl = document.getElementById('comingLoading');
    const gridEl = document.getElementById('comingMoviesGrid');
    const paginationEl = document.getElementById('comingPagination');
    
    try {
      // Hiển thị loading
      loadingEl.style.display = 'block';
      gridEl.innerHTML = '';
      paginationEl.style.display = 'none';
      
      // Gọi API
      const response = await fetch(`/api/movies/coming-soon?page=${page}&per_page=6`);
      const data = await response.json();
      
      if (data.success) {
        comingPaginationData = data.pagination;
        comingCurrentPage = data.pagination.current_page;
        comingTotalPages = data.pagination.total_pages;
        
        // Render movies
        renderComingSoonMovies(data.movies);
        
        // Render pagination nếu có nhiều hơn 1 trang
        if (comingTotalPages > 1) {
          renderPagination(data.pagination, 'coming');
        }
      } else {
        console.error('Error loading coming soon movies:', data.error);
        gridEl.innerHTML = '<div class="text-center text-muted">Không thể tải danh sách phim</div>';
      }
    } catch (error) {
      console.error('Error:', error);
      gridEl.innerHTML = '<div class="text-center text-muted">Lỗi kết nối</div>';
    } finally {
      loadingEl.style.display = 'none';
    }
  }

  // Render danh sách phim đang chiếu
  function renderShowingMovies(movies) {
    const gridEl = document.getElementById('showingMoviesGrid');
    
    if (!movies || movies.length === 0) {
      gridEl.innerHTML = '<div class="text-center text-muted">Không có phim đang chiếu</div>';
      return;
    }
    
    const moviesHTML = movies.map(movie => `
      <div class="col-4">
        <div class="card movie-card h-100 shadow">
          <img src="${movie.poster_url}" class="card-img-top" alt="${movie.title}" onerror="this.src='/static/img/showing_movie1.jpg'">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold mb-1">${movie.title}</h5>
            <div class="d-flex gap-2 mt-auto">
              <a href="/movie/${movie.id}" class="btn btn-darkred flex-fill rounded-pill fw-bold py-2">Đặt vé</a>
            </div>
          </div>
        </div>
      </div>
    `).join('');
    
    gridEl.innerHTML = `<div class="row g-4 justify-content-center">${moviesHTML}</div>`;
  }

  // Render danh sách phim sắp chiếu
  function renderComingSoonMovies(movies) {
    const gridEl = document.getElementById('comingMoviesGrid');
    
    if (!movies || movies.length === 0) {
      gridEl.innerHTML = '<div class="text-center text-muted">Không có phim sắp chiếu</div>';
      return;
    }
    
    const moviesHTML = movies.map(movie => `
      <div class="col-md-4">
        <div class="card movie-card h-100 shadow">
          <img src="${movie.poster_url}" class="card-img-top" alt="${movie.title}" onerror="this.src='/static/img/comingsoon_movie1.jpg'">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold mb-1">${movie.title}</h5>
            <div class="d-flex gap-2 mt-auto">
              <a href="#" class="btn btn-darkred flex-fill rounded-pill fw-bold py-2">Đặt vé</a>
              <a href="#" class="btn btn-outline-darkred flex-fill rounded-pill fw-bold py-2">Chi tiết</a>
            </div>
          </div>
        </div>
      </div>
    `).join('');
    
    gridEl.innerHTML = `<div class="row g-4 justify-content-center">${moviesHTML}</div>`;
  }

  // Render phân trang
  function renderPagination(pagination, type = 'showing') {
    const paginationEl = document.getElementById(type === 'showing' ? 'showingPagination' : 'comingPagination');
    const { current_page, total_pages, has_prev, has_next } = pagination;
    
    let paginationHTML = '';
    
    // Nút First Page
    paginationHTML += `<a href="#" class="pagination-btn" onclick="goToPage(1, '${type}')" ${current_page === 1 ? 'disabled' : ''}>«</a>`;
    
    // Nút Previous
    paginationHTML += `<a href="#" class="pagination-btn" onclick="goToPage(${current_page - 1}, '${type}')" ${!has_prev ? 'disabled' : ''}><</a>`;
    
    // Hiển thị các trang
    const startPage = Math.max(1, current_page - 2);
    const endPage = Math.min(total_pages, current_page + 2);
    
    // Dots trước nếu cần
    if (startPage > 1) {
      paginationHTML += `<span class="pagination-dots">...</span>`;
    }
    
    // Các trang số
    for (let i = startPage; i <= endPage; i++) {
      const isActive = i === current_page;
      paginationHTML += `<a href="#" class="pagination-btn ${isActive ? 'active' : ''}" onclick="goToPage(${i}, '${type}')">${i}</a>`;
    }
    
    // Dots sau nếu cần
    if (endPage < total_pages) {
      paginationHTML += `<span class="pagination-dots">...</span>`;
    }
    
    // Nút Next
    paginationHTML += `<a href="#" class="pagination-btn" onclick="goToPage(${current_page + 1}, '${type}')" ${!has_next ? 'disabled' : ''}>></a>`;
    
    // Nút Last Page
    paginationHTML += `<a href="#" class="pagination-btn" onclick="goToPage(${total_pages}, '${type}')" ${current_page === total_pages ? 'disabled' : ''}">»</a>`;
    
    // Thông tin trang hiện tại
    paginationHTML += `
      <div class="pagination-info">
        <input type="number" class="page-input" value="${current_page}" min="1" max="${total_pages}" onchange="goToPage(this.value, '${type}')">
        <span class="text-muted">of ${total_pages} pages</span>
      </div>
    `;
    
    paginationEl.innerHTML = paginationHTML;
    paginationEl.style.display = 'flex';
  }

  // Hàm chuyển trang
  function goToPage(page, type = 'showing') {
    const pageNum = parseInt(page);
    
    if (type === 'showing') {
      if (pageNum >= 1 && pageNum <= totalPages && pageNum !== currentPage) {
        loadShowingMovies(pageNum);
      }
    } else if (type === 'coming') {
      if (pageNum >= 1 && pageNum <= comingTotalPages && pageNum !== comingCurrentPage) {
        loadComingSoonMovies(pageNum);
      }
    }
  }
</script>
{% endblock %} 